<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸµ Meta MusicGen - å…è²» AI éŸ³æ¨‚ç”Ÿæˆå™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .glass { 
      background: rgba(255, 255, 255, 0.15); 
      backdrop-filter: blur(10px); 
      border: 1px solid rgba(255,255,255,0.25); 
    }
    .loader { 
      border: 3px solid #f3f3f3; 
      border-top: 3px solid #667eea; 
      border-radius: 50%; 
      width: 24px; 
      height: 24px; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="flex items-center justify-center p-4">
  <div class="glass rounded-3xl p-8 w-full max-w-3xl shadow-2xl fade-in">
    <!-- é ­éƒ¨ -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold text-white mb-3">ğŸµ Meta MusicGen</h1>
      <p class="text-white/90 text-lg mb-4">å…è²» AI éŸ³æ¨‚ç”Ÿæˆå™¨ Â· ç„¡é™å‰µä½œ</p>
      <div class="flex items-center justify-center gap-3 flex-wrap">
        <div class="inline-flex items-center gap-2 bg-green-500/30 px-4 py-2 rounded-full">
          <span class="w-2 h-2 bg-green-400 rounded-full pulse"></span>
          <span class="text-green-100 text-sm font-medium">åœ¨ç·šé‹è¡Œä¸­</span>
        </div>
        <div class="inline-flex items-center gap-2 bg-blue-500/30 px-4 py-2 rounded-full">
          <span class="text-blue-100 text-sm">âš¡ Zeabur</span>
        </div>
        <div class="inline-flex items-center gap-2 bg-purple-500/30 px-4 py-2 rounded-full">
          <span class="text-purple-100 text-sm">ğŸ†“ å®Œå…¨å…è²»</span>
        </div>
      </div>
    </div>

    <!-- è¡¨å–® -->
    <div class="space-y-6">
      <!-- éŸ³æ¨‚æè¿° -->
      <div>
        <label class="block text-white font-semibold mb-2 text-lg">ğŸ¼ éŸ³æ¨‚æè¿°</label>
        <textarea 
          id="prompt" 
          rows="4" 
          class="w-full bg-white/10 border border-white/30 rounded-xl p-4 text-white placeholder-white/50 focus:ring-2 focus:ring-white/50 focus:border-white/50 outline-none transition"
          placeholder="ä¾‹å¦‚: upbeat electronic dance music with synthesizers, 120 BPM, energetic and fun"
        ></textarea>
        <p class="text-white/60 text-sm mt-2">ğŸ’¡ æç¤º: ç”¨è‹±æ–‡æè¿°æ•ˆæœæ›´å¥½,å¯åŒ…å«é¢¨æ ¼ã€æ¨‚å™¨ã€æƒ…ç·’ç­‰</p>
      </div>

      <!-- é¢¨æ ¼å¿«é¸ -->
      <div>
        <label class="block text-white font-semibold mb-3 text-lg">ğŸ¨ å¿«é€Ÿé¸æ“‡é¢¨æ ¼</label>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
          <button onclick="setPrompt('lofi hip hop beats, chill, relaxing, study music')" 
                  class="bg-white/10 hover:bg-white/25 border border-white/30 rounded-xl p-3 text-white transition transform hover:scale-105 active:scale-95">
            ğŸ§ Lofi Hip Hop
          </button>
          <button onclick="setPrompt('epic cinematic orchestral music, dramatic, trailer music')" 
                  class="bg-white/10 hover:bg-white/25 border border-white/30 rounded-xl p-3 text-white transition transform hover:scale-105 active:scale-95">
            ğŸ¬ å²è©©é…æ¨‚
          </button>
          <button onclick="setPrompt('cyberpunk synthwave, futuristic electronic, retro')" 
                  class="bg-white/10 hover:bg-white/25 border border-white/30 rounded-xl p-3 text-white transition transform hover:scale-105 active:scale-95">
            ğŸ¤– è³½åšé¾å…‹
          </button>
          <button onclick="setPrompt('japanese city pop, 80s, funky bass, upbeat')" 
                  class="bg-white/10 hover:bg-white/25 border border-white/30 rounded-xl p-3 text-white transition transform hover:scale-105 active:scale-95">
            ğŸŒ¸ City Pop
          </button>
          <button onclick="setPrompt('emotional piano solo, sad and melancholic, slow tempo')" 
                  class="bg-white/10 hover:bg-white/25 border border-white/30 rounded-xl p-3 text-white transition transform hover:scale-105 active:scale-95">
            ğŸ¹ æ„Ÿäººé‹¼ç´
          </button>
          <button onclick="setPrompt('upbeat electronic dance music, EDM, energetic, party')" 
                  class="bg-white/10 hover:bg-white/25 border border-white/30 rounded-xl p-3 text-white transition transform hover:scale-105 active:scale-95">
            ğŸ’ƒ é›»å­èˆæ›²
          </button>
        </div>
      </div>

      <!-- æ¨¡å‹é¸æ“‡ -->
      <div>
        <label class="block text-white font-semibold mb-2 text-lg">ğŸ”§ AI æ¨¡å‹</label>
        <select id="model" class="w-full bg-white/10 border border-white/30 rounded-xl p-3 text-white">
          <option value="musicgen-small">MusicGen Small (å¿«é€Ÿ - ç´„15ç§’)</option>
          <option value="musicgen-medium" selected>MusicGen Medium (æ¨è–¦ - ç´„25ç§’)</option>
          <option value="musicgen-large">MusicGen Large (é«˜è³ªé‡ - ç´„35ç§’)</option>
        </select>
      </div>

      <!-- ç”ŸæˆæŒ‰éˆ• -->
      <button 
        id="generateBtn" 
        onclick="generate()" 
        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-5 rounded-xl transition transform hover:scale-[1.02] active:scale-95 shadow-lg text-lg"
      >
        âœ¨ é–‹å§‹ç”ŸæˆéŸ³æ¨‚
      </button>

      <!-- ç‹€æ…‹æç¤º -->
      <div id="status" class="hidden"></div>

      <!-- çµæœå€åŸŸ -->
      <div id="result" class="hidden fade-in">
        <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/30">
          <h3 class="text-2xl font-bold text-white mb-4 text-center">ğŸ‰ ç”ŸæˆæˆåŠŸ!</h3>
          <audio id="audioPlayer" controls class="w-full mb-4" controlsList="nodownload"></audio>
          <div class="flex gap-3">
            <a id="downloadLink" class="flex-1 text-center bg-white/20 hover:bg-white/30 py-3 rounded-lg text-white transition font-semibold">
              â¬‡ï¸ ä¸‹è¼‰éŸ³é »
            </a>
            <button onclick="generate()" class="flex-1 bg-purple-500/50 hover:bg-purple-500/70 py-3 rounded-lg text-white transition font-semibold">
              ğŸ”„ å†ç”Ÿæˆä¸€é¦–
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨èªªæ˜ -->
    <div class="mt-8 p-4 bg-white/10 rounded-xl border border-white/20">
      <h4 class="text-white font-bold mb-2">ğŸ“Œ ä½¿ç”¨èªªæ˜</h4>
      <ul class="text-white/80 text-sm space-y-1">
        <li>â€¢ é¦–æ¬¡ç”Ÿæˆå¯èƒ½éœ€è¦ 20-30 ç§’å–šé†’ AI æ¨¡å‹</li>
        <li>â€¢ å»ºè­°ä½¿ç”¨è‹±æ–‡æè¿°,æ•ˆæœæ›´ç²¾ç¢º</li>
        <li>â€¢ å¯ä»¥æŒ‡å®šé¢¨æ ¼ã€æ¨‚å™¨ã€ç¯€å¥ã€æƒ…ç·’ç­‰è¦ç´ </li>
        <li>â€¢ ç”Ÿæˆçš„éŸ³æ¨‚å¯å…è²»ä¸‹è¼‰å’Œå•†ç”¨</li>
      </ul>
    </div>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <div class="mt-8 text-center text-white/60 text-sm space-y-2">
      <p>Powered by Meta MusicGen Â· Deployed on Zeabur</p>
      <p>
        GitHub: 
        <a href="https://github.com/kinai9661/Meta-MusicGen" 
           class="text-white/80 hover:text-white underline" 
           target="_blank">kinai9661/Meta-MusicGen</a>
      </p>
      <p class="text-xs text-white/40 mt-4">
        ğŸš€ è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ Â· âš¡ æ™ºèƒ½æ¨¡å‹å–šé†’ Â· ğŸ†“ å®Œå…¨å…è²»é–‹æº
      </p>
    </div>
  </div>

  <script>
    // è¨­ç½® prompt
    function setPrompt(text) {
      document.getElementById('prompt').value = text
      document.getElementById('prompt').focus()
    }

    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status')
      status.classList.remove('hidden')
      
      const colors = {
        info: 'bg-blue-500/20 text-blue-100',
        success: 'bg-green-500/20 text-green-100',
        error: 'bg-red-500/20 text-red-100',
        warning: 'bg-yellow-500/20 text-yellow-100'
      }
      
      status.className = `block p-4 rounded-xl text-center ${colors[type] || colors.info}`
      status.innerHTML = message
    }

    // ç”ŸæˆéŸ³æ¨‚
    async function generate() {
      const prompt = document.getElementById('prompt').value.trim()
      const model = document.getElementById('model').value
      const btn = document.getElementById('generateBtn')
      const result = document.getElementById('result')

      if (!prompt) {
        alert('è«‹è¼¸å…¥éŸ³æ¨‚æè¿°!')
        document.getElementById('prompt').focus()
        return
      }

      // UI æ›´æ–°
      btn.disabled = true
      btn.innerHTML = '<div class="loader mx-auto"></div>'
      result.classList.add('hidden')
      
      // é¡¯ç¤ºé€²åº¦
      updateStatus(`
        <div class="space-y-3">
          <p class="font-bold">ğŸµ æ­£åœ¨å‰µä½œéŸ³æ¨‚...</p>
          <p class="text-sm">AI æ¨¡å‹æ­£åœ¨é‹ç®—ä¸­,é è¨ˆéœ€è¦ 20-40 ç§’</p>
          <p class="text-xs opacity-75">å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨,å¯èƒ½éœ€è¦å–šé†’æ¨¡å‹,è«‹è€å¿ƒç­‰å¾…</p>
          <div class="mt-3">
            <div class="w-full bg-white/20 rounded-full h-2">
              <div id="progress" class="bg-white h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
        </div>
      `, 'info')

      // æ¨¡æ“¬é€²åº¦æ¢
      let progress = 0
      const progressInterval = setInterval(() => {
        progress = Math.min(progress + 2, 90)
        const progressBar = document.getElementById('progress')
        if (progressBar) progressBar.style.width = progress + '%'
      }, 1000)

      try {
        const startTime = Date.now()
        
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, model })
        })

        clearInterval(progressInterval)
        const progressBar = document.getElementById('progress')
        if (progressBar) progressBar.style.width = '100%'

        if (!res.ok) {
          const data = await res.json()
          throw new Error(data.message || data.error || 'ç”Ÿæˆå¤±æ•—')
        }

        const blob = await res.blob()
        const url = URL.createObjectURL(blob)
        const duration = ((Date.now() - startTime) / 1000).toFixed(1)
        
        document.getElementById('audioPlayer').src = url
        document.getElementById('downloadLink').href = url
        document.getElementById('downloadLink').download = `musicgen_${Date.now()}.flac`
        
        result.classList.remove('hidden')
        updateStatus(`âœ… ç”ŸæˆæˆåŠŸ! è€—æ™‚ ${duration} ç§’`, 'success')
        
        // 3ç§’å¾Œéš±è—æˆåŠŸæç¤º
        setTimeout(() => {
          document.getElementById('status').classList.add('hidden')
        }, 3000)

      } catch (err) {
        clearInterval(progressInterval)
        
        console.error('ç”ŸæˆéŒ¯èª¤:', err)
        
        let errorMessage = err.message
        let hint = ''
        
        if (err.message.includes('loading')) {
          hint = 'è«‹ç­‰å¾… 30 ç§’å¾Œé‡è©¦,æ¨¡å‹æ­£åœ¨å–šé†’ä¸­...'
        } else if (err.message.includes('Key')) {
          hint = 'æœå‹™å™¨é…ç½®å•é¡Œ,è«‹è¯ç¹«ç®¡ç†å“¡'
        } else {
          hint = 'è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–ç¨å¾Œå†è©¦'
        }
        
        updateStatus(`
          <div class="space-y-2">
            <p class="font-bold">âŒ ${errorMessage}</p>
            <p class="text-sm">${hint}</p>
            <button onclick="generate()" class="mt-3 px-6 py-2 bg-red-500/50 hover:bg-red-500/70 rounded-lg transition">
              ğŸ”„ é‡è©¦
            </button>
          </div>
        `, 'error')
      } finally {
        btn.disabled = false
        btn.innerHTML = 'âœ¨ é–‹å§‹ç”ŸæˆéŸ³æ¨‚'
      }
    }

    // é é¢åŠ è¼‰æ™‚æª¢æŸ¥æœå‹™å™¨ç‹€æ…‹
    window.addEventListener('load', async () => {
      try {
        const res = await fetch('/health')
        const data = await res.json()
        console.log('ğŸš€ æœå‹™å™¨ç‹€æ…‹:', data)
        
        if (!data.apiKeyConfigured) {
          updateStatus('âš ï¸ æœå‹™å™¨æœªé…ç½® API Key,åŠŸèƒ½å¯èƒ½å—é™', 'warning')
        }
      } catch (err) {
        console.error('å¥åº·æª¢æŸ¥å¤±æ•—:', err)
      }
    })

    // éµç›¤å¿«æ·éµ: Ctrl/Cmd + Enter ç”Ÿæˆ
    document.getElementById('prompt').addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        generate()
      }
    })
  </script>
</body>
</html>